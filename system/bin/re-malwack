#!/system/bin/sh

# Define the path to the hosts file
hosts_file="/etc/hosts"
temp="/etc/hosts.tmp/hosts"

if [ $# -eq 0 ]; then
    echo "Usage: re-malwack [--restore[-original] | --blockporn | --whitelist <domain> | --hosts-update | --help]"
    echo "--update-hosts: Updates the hosts file."
    echo "--restore-original: Restore the hosts file to its original state. (Disable ads blocking)"
    echo "--blockporn: Block pornographic websites by adding entries to the hosts file."
    echo "--whitelist <domain>: Remove the specified domain from the hosts file."
    echo "--help: Display this help message."
else
    case "$1" in
        --restore-original)
            # Remove the current hosts file if it exists

            chmod 644 "$hosts_file"
            echo "Restored permissions for $hosts_file"

            if [ -f "$hosts_file" ]; then
                rm -f "$hosts_file"
                echo "Removed $hosts_file"

            fi

            # Create a new hosts file with default localhost entries
            echo "127.0.0.1 localhost" > "$hosts_file"
            echo "::1 localhost" >> "$hosts_file"

            # Restore the original permissions
            chmod 644 "$hosts_file"
            echo "Restored permissions for $hosts_file"

            # Notify completion
            echo "Restored $hosts_file to its original state"
            umount /system/etc/hosts
            ;;
        --blockporn)
            host="https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/porn-only/hosts"

            # Download the hosts file with curl renaming it to hosts
            if curl -o hosts "$host"; then
                # Check if the file was downloaded successfully

                # Check if the hosts file exists
                if [ -f "hosts" ]; then
                    # Append the downloaded hosts to the current hosts file
                    cat hosts >> "$hosts_file"

                    # Remove the downloaded hosts file
                    rm hosts

                    # Echo that the entry has been added
                    echo "Entry for $host added to $hosts_file"
                else
                    echo "Error: Downloaded file hosts does not exist."
                fi
            else
                echo "Error: Failed to download the hosts file."
            fi
            ;;
        --whitelist)
            # Check if the second argument (the domain) is provided
            if [ -z "$2" ]; then
                echo "Error: Please provide a domain to whitelist."
            else
                domain="$2"
                temp=$(mktemp)  # Create a temporary file
                if sed "/0\.0\.0\.0 $domain/d" "$hosts_file" > "$temp"; then
                    if mv "$temp" "$hosts_file"; then
                        echo "Whitelisted $domain in $hosts_file"
                    else
                        echo "Error: Failed to replace $hosts_file with the modified content."
                    fi
                else
                    echo "Error: Failed to remove $domain from $hosts_file."
                fi
                echo "Done"
            fi
            ;;
        --blacklist)
        # Currently working on it.
        if [ -z "$1" ]; then
            echo "Error: Please provide a domain to block."
        else
            mount -o rw,remount /system/etc
            mount -o rw,remount /system
            mount -o rw,remount /etc
            echo "0.0.0.0 $1" >> /etc/hosts
            echo "Done!"
            fi
        ;;    
        --update-hosts)
            host="https://hosts.ubuntu101.co.za/hosts"

            # Set a timeout value in seconds
            chmod 644 "$hosts_file"

            # Download the hosts file with curl renaming it to hosts
            su -c /data/data/com.termux/files/usr/bin/curl -o hosts "$host";
                # Check if the file was downloaded successfully

                # Check if the hosts file exists
            if [ -f "hosts" ]; then

                    #
                if [ -f "$hosts_file" ]; then
                    mkdir /data/adb/modules_update
                    cp -r /data/adb/modules/Re-Malwack /data/adb/modules_update
                    mv hosts /data/adb/modules_update/Re-Malwack/system/etc
                    chmod 0644 /data/adb/modules_update/Re-Malwack/system/etc/hosts
                    sleep 1
                    echo ""
                    echo "Done! Reboot to apply the update."
                fi

                    
                    # Echo that the entry has been added
                    echo "Entry for $host added to $hosts_file"
            else
                    echo "Error: Downloaded file hosts does not exist."
            fi
                echo "Error: Download failed. This is either an issue on your network or GitHub's backend."
                exit 1
        ;;
        --help)
            echo "Usage: re-malwack [--restore[-original] | --blockporn |--update-hosts| --whitelist <domain> | --help]"
            echo "--update-hosts: Updates the hosts file."
            echo "--restore-original: Restore the hosts file to its original state. (Disable ads blocking)"
            echo "--blockporn: Block pornographic websites by adding entries to the hosts file."
            echo "--whitelist <domain>: Remove the specified domain from the hosts file."
            echo "--help: Display this help message."
            ;;
        *)
            echo "Invalid option. Use 're-malwack --help' for usage information."
            ;;
    esac
fi
