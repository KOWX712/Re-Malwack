name: Update Hosts
permissions:
  contents: write
on:
  schedule:
    - cron: "0 0 * * *"  # Runs every 24 hours at midnight UTC
  workflow_dispatch:  # Allows manual triggering

jobs:
  update-hosts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up dependencies
        run: sudo apt update && sudo apt install -y curl

      - name: Download Hosts Files
        run: |
          mkdir -p hosts
          sources=(
            "https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts"
            "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/hosts/pro.plus-compressed.txt"
            "https://o0.pages.dev/Pro/hosts.txt"
            "https://raw.githubusercontent.com/r-a-y/mobile-hosts/master/AdguardDNS.txt"
            "https://raw.githubusercontent.com/r-a-y/mobile-hosts/refs/heads/master/AdguardMobileAds.txt"
            "https://raw.githubusercontent.com/r-a-y/mobile-hosts/refs/heads/master/AdguardMobileSpyware.txt"
            "https://hblock.molinero.dev/hosts"
          )
          for url in "${sources[@]}"; do
            curl -sL "$url" >> hosts/raw_hosts.txt
            echo "" >> hosts/raw_hosts.txt  # Ensure newline separation
          done

      - name: Verify Hosts Download
        run: |
          if [ ! -s hosts/raw_hosts.txt ]; then
            echo "Hosts file is empty! Download might have failed."
            exit 1
          fi

      - name: Download Whitelist
        run: |
            curl -sL "https://raw.githubusercontent.com/ZG089/Re-Malwack/main/whitelist.txt" -o hosts/whitelist.txt
  
      - name: Clean and Merge Hosts
        run: |
          echo "Cleaning hosts..."
          
          if [ ! -s hosts/raw_hosts.txt ]; then
            echo "Error: raw_hosts.txt is empty after download!" >&2
            exit 1
          fi
          sed '/^[[:space:]]*#/d; /^[[:space:]]*$/d; s/^[[:space:]]*//; s/\t/ /g; s/  */ /g' hosts/raw_hosts.txt > hosts/tmp_hosts.txt
          if [ ! -s hosts/tmp_hosts.txt ]; then
            echo "Error: Cleaning removed everything!" >&2
            exit 1
          fi
          sort -u hosts/tmp_hosts.txt > hosts/hosts.txt
          rm -f hosts/tmp_hosts.txt

      - name: Remove Whitelisted Domains
        run: |
              echo "Filtering whitelist..."
              if [ -s hosts/whitelist.txt ]; then
                grep -vFf hosts/whitelist.txt hosts/hosts.txt > hosts/tmp_hosts.txt || true
                mv hosts/tmp_hosts.txt hosts/hosts.txt
              else
                echo "Whitelist is empty or missing. Skipping..."
              fi
          
      - name: Checkout Repository (Full History)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fix shallow clone issues
      
      - name: Debug Git Status
        run: |
          echo "=== CURRENT DIRECTORY ==="
          pwd
          echo "=== LISTING FILES ==="
          ls -lah
          echo "=== LISTING HOSTS DIRECTORY ==="
          ls -lah hosts || echo "No hosts directory found!"
          echo "=== GIT STATUS ==="
          git status
          echo "=== GIT BRANCH ==="
          git branch
          echo "=== GIT LOG ==="
          git log --oneline -5
      
      - name: Ensure We Are on Main
        run: |
          git checkout main || git checkout -b main
      
      - name: Force Add Only hosts.txt
        run: |
          git add -f hosts/hosts.txt  # ONLY add hosts.txt
      
      - name: FORCE Commit and Push (No Change Checks)
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
          echo "Forcing commit..."
          git commit -m "Auto-update hosts file [$(date +'%Y-%m-%d')]" --allow-empty
          git push -u origin main --force
